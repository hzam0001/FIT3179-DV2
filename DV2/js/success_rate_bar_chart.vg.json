{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Horizontal grouped bar chart showing Success vs Failure rates (1957-2020) for selected countries",
  "background": "transparent",
  "config": { "view": { "stroke": "transparent" } },
  "title": {
    "text": "Mission success and failure rates from 1957 to 2020",
    "anchor": "middle",
    "fontSize": 17,
    "fontWeight": "bold",
    "offset": 20,
    "color": "white"
  },
  "width": 600,
  "height": 200,
  "data": { 
    "url": "https://raw.githubusercontent.com/hzam0001/FIT3179-DV2/refs/heads/main/DV2/data/total_missions.csv" 
  },
  "transform": [
    { "calculate": "toNumber(datum.Year)", "as": "YearNum" },
    { "calculate": "lower(trim(datum['Status Mission']))", "as": "status_norm" },
    { "calculate": "lower(trim(datum.Country))", "as": "country_norm" },
    { 
      "filter": "datum.YearNum >= 1957 && datum.YearNum <= 2020" 
    },
    {
      "calculate": "datum.country_norm == 'france' ? 'France' : datum.country_norm == 'india' ? 'India' : datum.country_norm == 'japan' || datum.country_norm == 'jpn' ? 'Japan' : datum.country_norm == 'usa' || datum.country_norm == 'united states' || datum.country_norm == 'united states of america' ? 'USA' : datum.country_norm == 'russia' || datum.country_norm == 'soviet union' || datum.country_norm == 'ussr' ? 'Russia' : datum.country_norm == 'kazakhstan' ? 'Kazakhstan' : datum.country_norm == 'china' ? 'China' : datum.country_norm == 'australia' || datum.country_norm == 'au' ? 'Australia' : null",
      "as": "Country"
    },
    { "filter": "datum.Country != null" },
    { 
      "calculate": "datum.status_norm == 'success' ? 'Success' : 'Failure'", 
      "as": "Status" 
    },
    { 
      "aggregate": [{ "op": "count", "as": "count" }], 
      "groupby": ["Country", "Status"] 
    },
    { 
      "joinaggregate": [{ "op": "sum", "field": "count", "as": "total" }], 
      "groupby": ["Country"] 
    },
    { 
      "calculate": "datum.count / datum.total * 100", 
      "as": "percentage" 
    },
    {
      "calculate": "format(datum.percentage, '.1f') + '% (' + format(datum.count, ',') + ' out of ' + format(datum.total, ',') + ' missions)'",
      "as": "tooltip_text"
    }
  ],
  "mark": {
    "type": "bar",
    "cornerRadiusEnd": 3,
    "width": {"band": 0.4}
  },
  "encoding": {
    "y": {
      "field": "Country",
      "type": "nominal",
      "title": null,
      "sort": ["USA", "Russia", "China", "Japan", "France", "India", "Kazakhstan", "Australia"],
      "axis": {
        "labelFontSize": 12,
        "labelFontWeight": 500,
        "labelColor": "white",
        "domainColor": "white",
        "tickColor": "white",
        "grid": false
      }
    },
    "yOffset": {
      "field": "Status",
      "type": "nominal",
      "scale": {"paddingInner": 0.3}
    },
    "x": {
      "field": "percentage",
      "type": "quantitative",
      "title": "Percentage of Missions (%)",
      "axis": {
        "labelFontSize": 11,
        "titleFontSize": 12,
        "titleFontWeight": 500,
        "gridOpacity": 0.3,
        "labelColor": "white",
        "titleColor": "white",
        "domainColor": "white",
        "tickColor": "white",
        "grid":false
        
      },
      "scale": {
        "domain": [0, 100]
      }
    },
    "color": {
      "field": "Status",
      "type": "nominal",
      "scale": {
        "domain": ["Success", "Failure"],
        "range": ["#10b981", "#ef4444"]
      }
    },
    "tooltip": [
      {
        "field": "Country",
        "type": "nominal",
        "title": "Country"
      },
      {
        "field": "Status",
        "type": "nominal",
        "title": "Status"
      },
      {
        "field": "tooltip_text",
        "type": "nominal",
        "title": "Details"
      }
    ]
  }
}